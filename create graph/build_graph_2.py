from neo4j import GraphDatabase

# ========== 1. 配置 Neo4j Aura 连接 ==========
NEO4J_URI = "neo4j+s://36f08b4f.databases.neo4j.io"
NEO4J_USER = "neo4j"
NEO4J_PASSWORD = "Z-kmRY5XTupSahevPpRzQZqpRfFcw0ApigFBfDVFyQo"  

driver = GraphDatabase.driver(NEO4J_URI, auth=(NEO4J_USER, NEO4J_PASSWORD))

# ========== 2. 定义三个白名单词表 ==========

EQUIPMENT_TERMS = [
    # 冲压工艺-材料准备
    "开卷机",
    "矫平机",
    "落料剪切机",
    "料架",
    "输送机",
    "行车吊具",

    # 冲压工艺-模具安装与调试
    "大型冲压机",
    "机械压力机",
    "液压压力机",
    "济南二机",
    "模具快速更换装置",
    "天车起重机",

    # 冲压工艺-冲压成形
    "冲压机主机",
    "压床控制系统",
    "送料机械手",
    "自动化上料装置",
    "1000 吨以上压力机",
    "模具",
    "传送装置",

    # 冲压工艺-修边冲孔
    "中小型冲压机",
    "后续工位压力机",
    "修边模",
    "冲孔模",
    "工装夹具",
    "机器人抓取与搬运系统",

    # 冲压工艺-取出与堆垛
    "机械手",
    "真空吸盘装置",
    "堆垛架",
    "托盘",
    "自动输送线",

    # 冲压工艺-质量检验
    "三坐标测量机",
    "光学扫描仪",
    "表面缺陷检测灯",
    "样板检具",
    "拉伸试验机",
    "硬度计",

    # 焊接工艺-零件预处理
    "去毛刺机",
    "矫形台",
    "点焊夹具预装平台",
    "输送线",
    "工位器具",

    # 焊接工艺-夹具装夹与定位
    "总拼夹具",
    "工作台",
    "子总成夹具",
    "装夹定位夹具",
    "气动压紧装置",
    "液压站",
    "PLC 控制柜",
    "自动化线体",
    "机器人上料",

    # 焊接工艺-点焊/弧焊/激光焊接
    "点焊机器人",
    "点焊变压器",
    "中频逆变电源",
    "弧焊机器人",
    "焊机",
    "送丝机",
    "保护气体供应系统",
    "激光焊接机",
    "激光器",
    "振镜",
    "焊接专用夹具",
    "冷却系统",

    # 焊接工艺-焊后整形与清理
    "打磨机",
    "抛光机",
    "专用整形工装",
    "吸尘装置",
    "废屑收集系统",

    # 焊接工艺-质量检验
    "拉剪试验机",
    "超声波检测仪",
    "涡流检测仪",
    "X 射线探伤设备",

    # 涂装工艺-前处理
    "多工位喷淋与浸泡清洗线",
    "热水清洗槽",
    "表调槽",
    "磷化槽",
    "纯水漂洗槽",
    "烘干炉",
    "循环过滤系统",
    "加热器",
    "泵阀管路系统",

    # 涂装工艺-电泳涂装
    "电泳槽",
    "超滤系统",
    "水洗槽",
    "回收系统",
    "循环泵",
    "整流电源",
    "阳极隔膜系统",
    "悬挂输送链",

    # 涂装工艺-中涂与面漆喷涂
    "自动喷涂机器人",
    "雾化器",
    "喷房",
    "循环空气净化系统",
    "烘烤炉",
    "流平区",
    "干式过滤器",
    "水帘系统",

    # 涂装工艺-烘烤与冷却
    "热风循环烘炉",
    "红外加热器",
    "温控系统",
    "输送链",
    "冷却通道",
    "温度记录仪",

    # 涂装工艺-返修与打磨抛光
    "局部烘烤灯",
    "小型喷涂房",
    "粉尘收集装置",

    # 涂装工艺-质量检验
    "膜厚仪",
    "光泽度计",
    "色差仪",
    "百格刀/划格试验器",
    "盐雾试验箱",
    "照明检视灯",
    "外观评价光源箱",

    # 总装工艺-车身接收与门盖拆卸
    "升降台",
    "门盖拆装专用工装",
    "周转小车",

    # 总装工艺-一次内饰安装
    "车身托举工位",
    "线束供料小车",
    "吸附定位装置",
    "工位照明系统",

    # 总装工艺-底盘与动力总成安装
    "合装升降台",
    "AGV",
    "滑板线",
    "螺栓拧紧系统",
    "定位导向销",
    "冷却系统安装台架",
    "排气系统装配工位",

    # 总装工艺-二次内饰及电气装配
    "吊装滑轨",
    "真空吸附工装",
    "座椅搬运小车",
    "拧紧系统",
    "电检测试工位",

    # 总装工艺-外饰件安装
    "玻璃胶涂布与定位装置",
    "灯具定位夹具",
    "保险杠装配台",

    # 总装工艺-液体加注与功能检测
    "自动加注系统",
    "冷却液加注机",
    "制动液加注及循环排气装置",
    "动力转向液加注系统",
    "空调制冷剂加注机",
    "发动机机油自动加注台",
    "变速箱油自动加注台",
    "ECU 诊断仪",
    "灯光音响测试台",

    # 总装工艺-整车检测
    "四轮定位仪",
    "定位台",
    "灯光检测仪",
    "制动试验台",
    "滚筒测功机",
    "密封性淋雨测试房",
    "道路试车跑道",
]

TOOL_TERMS = [
    # 冲压工艺-材料准备
    "除毛刺工具",
    "清洁刷",
    "测量尺",

    # 冲压工艺-模具安装与调试
    "冲压模具",
    "上模",
    "下模",
    "定位销",
    "压模夹紧块",
    "扭力扳手",
    "扭矩扳手",
    "六角扳手",

    # 冲压工艺-冲压成形
    "润滑喷涂装置",
    "冲压废料收集箱",
    "清洁布",
    "防护手套",
    "检具",
    "卡规",

    # 冲压工艺-修边冲孔
    "冲头",
    "刀口修磨工具",
    "冲孔废料回收设备",
    "夹具校正器",

    # 冲压工艺-取出与堆垛
    "吸盘式取件工具",
    "夹持钳",
    "撬棍",
    "防刮伤隔离垫片",
    "防护角",

    # 冲压工艺-质量检验
    "卡尺",
    "深度尺",
    "塞规",
    "轮廓规",
    "模板检具",

    # 焊接工艺-零件预处理
    "除油剂喷壶",
    "抹布",
    "钢丝刷",
    "锤子",

    # 焊接工艺-夹具装夹与定位
    "快换夹具手柄",
    "检具针",

    # 焊接工艺-点焊/弧焊/激光焊接
    "电极帽修磨器",
    "焊丝钳",
    "焊缝清理锤",
    "喷防飞溅剂喷枪",
    "焊缝跟踪传感器调试工具",

    # 焊接工艺-焊后整形与清理
    "砂轮片",
    "百叶片",
    "锉刀",
    "板手锤",
    "量规",

    # 焊接工艺-质量检验
    "焊缝尺",
    "焊缝外观评定样板",
    "探伤耦合剂",

    # 涂装工艺-前处理
    "pH 试纸",
    "pH 计",
    "温度计",
    "浓度计",
    "取样瓶",

    # 涂装工艺-电泳涂装
    "导电率仪",
    "电压表",
    "取样杯",
    "清洗喷枪",

    # 涂装工艺-中涂与面漆喷涂
    "喷枪校验规",
    "粘度杯",
    "遮蔽胶带",
    "除尘布",
    "静电除尘器",

    # 涂装工艺-烘烤与冷却
    "温度记录贴",
    "热电偶",
    "红外测温仪",
    "计时器",

    # 涂装工艺-返修与打磨抛光
    "砂纸",
    "抛光海绵",
    "抛光剂",
    "遮蔽纸",
    "色卡",
    "测光仪",

    # 涂装工艺-质量检验
    "放大镜",
    "胶带",
    "试验刮板",

    # 总装工艺-车身接收与门盖拆卸
    "电动扳手",
    "门铰链固定工具",
    "防护垫",

    # 总装工艺-一次内饰安装
    "卡扣压装工具",
    "扎带枪",
    "内饰拆装撬棒",
    "标识条",

    # 总装工艺-底盘与动力总成安装
    "电动拧紧枪",
    "液压搬运器",
    "快速接头工具",
    "润滑注油枪",

    # 总装工艺-二次内饰及电气装配
    "卡扣压装器",
    "塑料铆钉枪",
    "线束端子压接钳",
    "电气测试夹具",

    # 总装工艺-外饰件安装
    "涂胶枪",
    "真空吸盘",
    "定位夹具",
    "电动工具",

    # 总装工艺-液体加注与功能检测
    "手持式扭矩扳手",
    "漏液检查工具",
    "照明检查灯",
    "充电器",
    "高压防护手套",

    # 总装工艺-整车检测
    "车载诊断电脑",
    "故障扫描仪",
    "听音棒",
    "NVH 检测设备",
    "测漏仪",
    "内视镜",
    "记分表",
    "检查清单",
]

MATERIAL_TERMS = [
    # 冲压工艺-材料准备
    "冷轧钢板",
    "镀锌板",
    "高强度钢板",
    "铝合金板材",
    "表面清洁剂",
    "冲压润滑油",

    # 冲压工艺-模具安装与调试
    "模具钢",
    "润滑油脂",
    "垫片",

    # 冲压工艺-冲压成形
    "金属板料坯件",
    "模内润滑剂",
    "拉深油",

    # 冲压工艺-修边冲孔
    "废料边角料",
    "金属零件毛坯",

    # 冲压工艺-取出与堆垛
    "成形完成的金属零件",
    "垫纸",
    "周转箱",
    "托盘",

    # 冲压工艺-质量检验
    "被检零件样品",
    "标准样件",
    "合格样板",
    "合格/不合格标签纸",

    # 焊接工艺-零件预处理
    "冲压零件",
    "清洗剂",
    "酒精",
    "抹布",
    "焊接防飞溅剂",

    # 焊接工艺-夹具装夹与定位
    "钣金零件",
    "可更换接触垫块",

    # 焊接工艺-点焊/弧焊/激光焊接
    "点焊电极帽",
    "焊丝 ER70S-6",
    "保护气体",
    "混合气 Ar+CO₂",
    "纯 CO₂",
    "激光焊接粉末",
    "填丝",
    "清洁剂",

    # 焊接工艺-焊后整形与清理
    "砂轮",
    "抛光片",
    "防锈油",
    "钣金填充材料",

    # 焊接工艺-质量检验
    "抽检试样",
    "对比样件",
    "标识标签",
    "防锈处理剂",

    # 涂装工艺-前处理
    "脱脂剂",
    "表调剂",
    "磷化液",
    "纯水",
    "压缩空气",

    # 涂装工艺-电泳涂装
    "阴极电泳漆",
    "超滤透出液",
    "UF 渗透液",
    "清洗水",
    "中和剂",
    "防泡剂",

    # 涂装工艺-中涂与面漆喷涂
    "中涂漆",
    "面漆",
    "清漆",
    "稀释剂",
    "固化剂",
    "遮蔽纸",
    "胶带",
    "静电除尘布",

    # 涂装工艺-烘烤与冷却
    "涂层样块",
    "温度记录贴",
    "清洁布",

    # 涂装工艺-返修与打磨抛光
    "补漆材料",
    "抛光剂",
    "擦拭布",

    # 涂装工艺-质量检验
    "试验板",
    "对比样",

    # 总装工艺-车身接收与门盖拆卸
    "门盖总成",
    "固定螺栓",
    "防护材料",

    # 总装工艺-一次内饰安装
    "内饰地毯",
    "隔音棉",
    "线束",
    "卡扣",
    "扎带",

    # 总装工艺-底盘与动力总成安装
    "发动机总成",
    "变速器",
    "半轴",
    "悬架臂",
    "转向机构",
    "制动卡钳",
    "刹车盘",
    "紧固件",
    "密封圈",
    "润滑油脂",

    # 总装工艺-二次内饰及电气装配
    "座椅总成",
    "安全带",
    "门板",
    "中控台线束",
    "电控模块",
    "装饰件",

    # 总装工艺-外饰件安装
    "前后保险杠",
    "格栅",
    "灯具总成",
    "后视镜",
    "挡风玻璃",
    "密封胶条",

    # 总装工艺-液体加注与功能检测
    "发动机机油",
    "变速箱油",
    "自动变速器油液",
    "冷却液",
    "防冻液",
    "制动液",
    "离合器液",
    "转向助力油",
    "空调冷媒 R134a",
    "空调冷媒 R1234yf",
    "清洁擦拭布",

    # 总装工艺-整车检测
    "测试用燃料",
    "氮气",
    "刹车片磨耗检查参考件",
    "密封条",
    "胶条",
    "标准砝码",
    "标准器具",
    "润滑脂",
    "润滑剂",
]


# ========== 3. 从 TEXT_UNIT 中读取“设备/工具/材料”类文本 ==========

def fetch_text_units():
    """
    从 Neo4j 读出所有 info_type 为 设备/工具/材料 的 TEXT_UNIT，
    以及对应的 STAGE（用于建立 HAS_* 关系）。
    """
    query = """
    MATCH (t:TEXT_UNIT)-[:ABOUT_STAGE]->(s:STAGE)
    WHERE t.info_type IN ['设备', '工具', '材料']
    RETURN t.id AS id, t.info_type AS info_type, t.content AS content,
           s.name AS stage_name, s.process_name AS process_name
    """
    with driver.session() as session:
        result = session.run(query)
        return list(result)


# ========== 4. 根据词表在 content 中查找实体，并写入图谱 ==========

def enrich_entities():
    records = fetch_text_units()
    print(f"共找到 {len(records)} 条 设备/工具/材料 类型的 TEXT_UNIT")

    with driver.session() as session:

        def _write(tx):
            for r in records:
                tu_id = r["id"]
                info_type = r["info_type"]
                content = r["content"]
                stage_name = r["stage_name"]
                process_name = r["process_name"]

                if info_type == "设备":
                    term_list = EQUIPMENT_TERMS
                    label = "EQUIPMENT"
                    has_rel = "HAS_EQUIPMENT"
                    desc_rel = "DESCRIBES_EQUIPMENT"
                elif info_type == "工具":
                    term_list = TOOL_TERMS
                    label = "TOOL"
                    has_rel = "HAS_TOOL"
                    desc_rel = "DESCRIBES_TOOL"
                elif info_type == "材料":
                    term_list = MATERIAL_TERMS
                    label = "MATERIAL"
                    has_rel = "HAS_MATERIAL"
                    desc_rel = "DESCRIBES_MATERIAL"
                else:
                    continue  # 理论上不会到这里

                # 在 content 中查找所有出现的词
                for term in term_list:
                    if term and term in content:
                        # 用 f-string 写 label 和关系类型，用参数传具体值
                        query = f"""
                        MATCH (t:TEXT_UNIT {{id: $tu_id}})
                        MATCH (s:STAGE {{name: $stage_name, process_name: $process_name}})
                        MERGE (e:{label} {{name: $term}})
                        MERGE (s)-[:{has_rel}]->(e)
                        MERGE (t)-[:{desc_rel}]->(e)
                        """
                        tx.run(query, {
                            "tu_id": tu_id,
                            "stage_name": stage_name,
                            "process_name": process_name,
                            "term": term,
                        })

        session.execute_write(_write)

    print("实体节点与关系构建完成！")


if __name__ == "__main__":
    enrich_entities()
    driver.close()
